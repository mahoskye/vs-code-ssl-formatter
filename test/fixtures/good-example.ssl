/* Sample SSL file demonstrating proper formatting and style
 * This file follows the SSL Style Guide v1.0.0
 * Purpose: Calculate employee bonuses and generate reports
 */

:INCLUDE "common/utilities.ssl";
:INCLUDE "lib/database.ssl";

/* Region: Configuration constants */
:REGION Configuration
	:DECLARE MAX_BONUS_PERCENT := 15.0;
	:DECLARE MIN_PERFORMANCE_SCORE := 3.5;
	:DECLARE BONUS_MULTIPLIER := 1.2e3;
:ENDREGION

/* Main procedure to calculate and distribute bonuses */
:PROCEDURE CalculateEmployeeBonuses;
	:PARAMETERS nYear, sDepartment, bIncludeContractors := .F.;

	:DECLARE nTotalEmployees := 0;
	:DECLARE nQualifiedCount := 0;
	:DECLARE nTotalBonus := 0.0;
	:DECLARE aEmployeeList := {};
	:DECLARE sReportPath := "";
	:DECLARE dProcessDate := Today();

	:TRY
		/* Validate input parameters */
		:IF nYear < 2020 .OR. nYear > Year(Today())
			:ERROR "Invalid year specified";
			:RETURN .F.;
		:ENDIF

		/* Fetch employee data from database */
		aEmployeeList := GetEmployeesByDepartment(sDepartment, nYear);
		nTotalEmployees := Len(aEmployeeList);

		/* Process each employee */
		:FOR i := 1 :TO nTotalEmployees :STEP 1
			:DECLARE oEmployee := aEmployeeList[i];
			:DECLARE nPerformanceScore := oEmployee.PerformanceScore;
			:DECLARE nBaseSalary := oEmployee.BaseSalary;
			:DECLARE nBonus := 0.0;

			/* Determine eligibility and calculate bonus */
			:IF nPerformanceScore >= MIN_PERFORMANCE_SCORE
				:BEGINCASE
					:CASE nPerformanceScore >= 4.5
						nBonus := nBaseSalary * (MAX_BONUS_PERCENT / 100.0);
					:CASE nPerformanceScore >= 4.0
						nBonus := nBaseSalary * 0.10;
					:CASE nPerformanceScore >= 3.5
						nBonus := nBaseSalary * 0.05;
					:OTHERWISE
						nBonus := 0.0;
				:ENDCASE

					/* Apply multiplier for exceptional cases */
					:IF oEmployee.IsTopPerformer == .T.
						nBonus := nBonus * 1.25;
					:ENDIF

					nQualifiedCount += 1;
					nTotalBonus += nBonus;

					/* Update employee record */
					UpdateEmployeeBonus(oEmployee.EmployeeID, nBonus, nYear);
				:ENDIF
		:NEXT

		/* Generate summary report */
		:DECLARE sMessage := "Processed " + AllTrim(Str(nTotalEmployees)) + " employees";
		sMessage += ", " + AllTrim(Str(nQualifiedCount)) + " qualified";
		LogMessage(sMessage, "INFO");

		sReportPath := GenerateBonusReport(sDepartment, nYear, nTotalBonus);

	:CATCH oError
		/* Handle any errors during processing */
		LogError("Bonus calculation failed: " + oError.Message);
		:RETURN .F.;
	:FINALLY
		/* Cleanup resources */
		CloseConnections();
	:ENDTRY

	:RETURN .T.;
:ENDPROC

/* Helper function to validate employee data */
:PROCEDURE ValidateEmployeeData;
	:PARAMETERS oEmployee;

	:DECLARE bIsValid := .T.;

	:IF oEmployee == NIL
		:RETURN .F.;
	:ENDIF

	:IF Empty(oEmployee.EmployeeID) .OR. Empty(oEmployee.BaseSalary)
		bIsValid := .F.;
	:ENDIF

	:IF oEmployee.BaseSalary <= 0 .OR. oEmployee.PerformanceScore < 0
		bIsValid := .F.;
	:ENDIF

	:RETURN bIsValid;
:ENDPROC

/* Class for managing bonus calculations */
:CLASS BonusCalculator
	:DECLARE nDefaultRate;
	:DECLARE bDebugMode;

	/* Initialize calculator with default rate */
	:PROCEDURE Initialize;
		:PARAMETERS nRate := 10.0;
		nDefaultRate := nRate;
		bDebugMode := .F.;
	:ENDPROC

	/* Calculate bonus using configured rate */
	:PROCEDURE Calculate;
		:PARAMETERS nSalary, nMultiplier := 1.0;

		:DECLARE nResult := 0.0;

		:IF nSalary > 0
			nResult := nSalary * (nDefaultRate / 100.0) * nMultiplier;
		:ENDIF

		:RETURN nResult;
	:ENDPROC
:ENDCLASS

