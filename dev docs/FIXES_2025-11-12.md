# SSL Formatter - Issues Fixed

## Date: 2025-11-12

### Issues Reported and Resolved

#### 1. Keywords Not Being Highlighted
**Problem**: SSL keywords were not being syntax highlighted in the editor.

**Root Cause**: The `keywords-colon` regex pattern in `syntaxes/ssl.tmLanguage.json` had a typo - it was matching `::` (double colon) instead of `:` (single colon).

**Fix**: Changed line 231 from:
```json
"match": "(?i)::(?:IF|ELSE|..."
```
To:
```json
"match": "(?i):(?:IF|ELSE|..."
```

Also added missing keywords: `ELSEIF`, `ENDPROCEDURE`, `FOREACH`, `IN`

**File**: `syntaxes/ssl.tmLanguage.json`

---

#### 2. Invalid `:DECLARE` Syntax Not Detected
**Problem**: The extension was not detecting invalid syntax like `:DECLARE nValue := 5;`. In SSL, `:DECLARE` can only declare variables, not initialize them. Initialization must be on a separate line.

**Valid**:
```ssl
:DECLARE nValue;
nValue := 5;
```

**Invalid**:
```ssl
:DECLARE nValue := 5;  // WRONG!
```

**Fix**: Added validation in `sslDiagnosticProvider.ts` to:
1. Detect when `:DECLARE` includes `:=` operator
2. Report it as an Error with code `ssl-invalid-declare`
3. Skip Hungarian notation checking for invalid declarations

**File**: `src/sslDiagnosticProvider.ts` (lines 151-195)

---

#### 3. Invalid `const` Keyword Not Detected
**Problem**: SSL does not have a `const` keyword, but the extension was not flagging its use as an error.

**Examples of Invalid Code**:
```ssl
:DECLARE const max_bonus_percent := 15.0;  // WRONG!
:DECLARE CONST min_performance_score := 3.5;  // WRONG!
```

**Fix**: Added validation in `sslDiagnosticProvider.ts` to:
1. Detect `const` or `CONST` keywords in `:DECLARE` statements
2. Report them as Errors with code `ssl-invalid-const`
3. Skip Hungarian notation checking for invalid declarations

**File**: `src/sslDiagnosticProvider.ts` (lines 171-180)

---

#### 4. String Contents Being Modified During Formatting
**Problem**: The formatter was modifying text inside string literals, which should never happen. For example:
```ssl
sMessage := "if you need help, endif the session";
```
Was being formatted to:
```ssl
sMessage := ":IF you need help, :ENDIF the session";  // WRONG!
```

**Root Cause**: The formatting functions were using global regex replacements without checking if the matched text was inside a string literal.

**Fix**: Implemented a comprehensive solution:

1. Created a `replaceOutsideStrings()` helper method that:
   - Parses each line to identify string segments
   - Tracks whether we're inside single or double quotes
   - Only applies replacements to non-string segments

2. Updated all formatting methods to use this helper:
   - `normalizeKeywordCase()` - now processes line-by-line
   - `normalizeBuiltinFunctionCase()` - now processes line-by-line  
   - `normalizeOperatorSpacing()` - now processes line-by-line with string protection

3. Fixed operator spacing regex to handle chained operators correctly:
   - Used a loop to apply replacements until no more changes occur
   - This handles cases like `y+z*2` being formatted to `y + z * 2`

**Files**: `src/sslFormattingProvider.ts` (multiple sections)

---

### New Tests Added
Created comprehensive test suite in `test/sslDiagnosticAdvanced.test.ts` (11 new tests):

**Invalid Syntax Detection Tests**:
- Detects invalid `:DECLARE` with initialization
- Detects invalid `const` keyword (lowercase)
- Detects invalid `CONST` keyword (uppercase)
- Accepts valid `:DECLARE` without initialization

**String Preservation Tests**:
- Preserves strings during keyword formatting
- Preserves strings during operator spacing
- Preserves strings during function name formatting
- Formats actual function calls but not strings
- Preserves quoted paths with operators

**Complex Scenarios**:
- Handles mixed valid and invalid declarations
- Formats code while preserving multiple string types

### Test Results
- **Before fixes**: 27 failing tests
- **After initial fixes**: 0 failing tests (129 passing)
- **After new tests added**: 0 failing tests (140 passing)

---

### Example of Fixed Behavior

**Input (bad-example.ssl)**:
```ssl
:DECLARE const max_bonus_percent := 15.0;
sMessage := "if you need to return, endif this process";
result := alltrim("  alltrim removes spaces  ");
```

**Previous Behavior (WRONG)**:
- No error on `const` keyword
- No error on `:=` in :DECLARE
- String contents modified: `"if you need to :RETURN, :ENDIF this process"`
- String contents modified: `"  AllTrim removes spaces  "`

**New Behavior (CORRECT)**:
- ✅ Error: "Invalid syntax: 'const' is not a valid SSL keyword"
- ✅ Error: "Invalid syntax: :DECLARE cannot initialize values"
- ✅ String contents preserved exactly: `"if you need to return, endif this process"`
- ✅ String contents preserved exactly: `"  alltrim removes spaces  "`
- ✅ Function call formatted: `AllTrim("  alltrim removes spaces  ")`

---

### Files Modified

1. **src/sslDiagnosticProvider.ts**
   - Added detection for invalid `:DECLARE` with initialization
   - Added detection for invalid `const` keyword usage

2. **src/sslFormattingProvider.ts**
   - Implemented `replaceOutsideStrings()` helper method
   - Updated `normalizeKeywordCase()` to preserve strings
   - Updated `normalizeBuiltinFunctionCase()` to preserve strings
   - Updated `normalizeOperatorSpacing()` to preserve strings
   - Fixed operator spacing to handle chained operators

3. **syntaxes/ssl.tmLanguage.json**
   - Fixed keyword highlighting regex (:: → :)
   - Added missing keywords

4. **test/sslDiagnosticAdvanced.test.ts** (NEW)
   - Added 11 comprehensive tests for the fixed issues

---

### Recommendations for Future

1. **Add more fixture files** with known good and bad examples
2. **Test formatting round-trip**: Format → Save → Format again should be idempotent
3. **Add performance tests** for large files
4. **Document edge cases** in the style guide
5. **Consider adding quick fixes** for common errors (e.g., "Remove const keyword" code action)
